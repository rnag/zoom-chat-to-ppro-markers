"use strict";addStringMethods();var project=app.project,projectItems=project.rootItem.children,numProjectItems=projectItems.numItems,typeClip=ProjectItemType.CLIP,typeFile=ProjectItemType.FILE,sep=Folder.fs=="Macintosh"?"/":"\\";numProjectItems===0&&exitErr("Script requires a project item!");var colors={GREEN:0,RED:1,PURPLE:2,ORANGE:3,YELLOW:4,WHITE:5,BLUE:6,CYAN:7},folderToChatFiles={};function main(){for(var e,t,r,i,a,n=0;n<numProjectItems;n++)if(e=projectItems[n],a=e.name,r=e.type,updateEventPanel("[Checking Project Item #"+(n+1)+"]"),updateEventPanel("Name: "+a),e.isSequence())updateEventPanel("Skipping Sequence.");else if(r!=typeClip&&r!=typeFile)updateEventPanel("Skipping. Can only add markers to footage items.");else if(t=getFolderName(e),t)if(updateEventPanel("Media Path: "+t),i=e.getMarkers(),i.numMarkers)updateEventPanel("Skipping. Clip already has markers.");else{var o=folderToChatFiles[t];o===void 0&&(o=folderToChatFiles[t]=new Folder(t).getFiles("*.chat"));var s=o.length;if(!s)updateEventPanel("Skipping. No *.chat file(s) found in media path.");else{updateEventPanel("Adding markers.");for(var f=0;f<s;f++){var l=o[f];l instanceof File&&l.exists&&createClipMarkersFromChatFile(i,l)}}}else updateWithError("Unable to determine media path of clip.")}function createClipMarkersFromChatFile(e,t){var r=null,i,a;readTextFile(t,function(n){var o=n.split("	"),s=o[0].trim(),f=convertTimecodeToSeconds(s);o.length===3&&f?(r&&createMarker(e,i,a,r),i=f,a=o[1].trim().slice(0,-1),r=o[2].trim()):r+="\n"+n}),r&&createMarker(e,i,a,r)}function createMarker(e,t,r,i){var a=e.createMarker(t),n=i.toLowerCase().split(" ");a.name=r,a.comments=i;for(var o=colors.GREEN,s,f=0;f<n.length;f++)s=n[f],s==="cut"||s==="edit"?o=colors.RED:s==="fix"||s==="replace"?o=colors.ORANGE:s==="audio"||s==="sound"?o=colors.YELLOW:s=="reacted"&&(o=colors.PURPLE);a.setColorByIndex(o)}function exitErr(e){alert(e),exit(-1)}function updateEventPanel(e){app.setSDKEventMessage(e,"info")}function updateWithError(e){app.setSDKEventMessage(e,"error")}function addStringMethods(){typeof String.prototype.trim=="undefined"&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")})}function getFolderName(e){if(!e)return null;var t=e.getMediaPath(),r=t.lastIndexOf(sep);return r>-1?t.slice(0,r):t}function convertTimecodeToSeconds(e){var t=e.split(":");if(t.length!==3)return 0;var r=parseInt(t[0])*3600,i=parseInt(t[1])*60,a=parseInt(t[2]);if(isNaN(r)||isNaN(i)||isNaN(a))return 0;var n=r+i+a;return n}function readTextFile(e,t){var r=e instanceof File?e:new File(e);if(r.exists){r.open("r")||exitErr("Unable to open file "+decodeURI(r.name)),r.encoding||(r.encoding="UTF-8");var i=r.read();r.close();var a=i.split("\n");if(typeof t=="function")for(var n=0;n<a.length;n++)t(a[n],n);return i}else return!1}main();
