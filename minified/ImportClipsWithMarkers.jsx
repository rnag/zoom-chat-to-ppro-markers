"use strict";addStringMethods();var project=app.project,sep=Folder.fs=="Macintosh"?"/":"\\",colors={GREEN:0,RED:1,PURPLE:2,ORANGE:3,YELLOW:4,WHITE:5,BLUE:6,CYAN:7},folderToChatFiles={};function main(){importFiles();for(var r=project.rootItem.children,t=r.numItems,e,n,a,i,s,o=0;o<t;o++)if(e=r[o],s=e.name,a=e.type,updateEventPanel("[Checking Project Item #"+(o+1)+"]"),updateEventPanel("Name: "+s),e.isSequence())updateEventPanel("Skipping Sequence.");else if(a!=typeClip&&a!=typeFile)updateEventPanel("Skipping. Can only add markers to footage items.");else if(n=getFolderName(e),n)if(updateEventPanel("Media Path: "+n),i=e.getMarkers(),i.numMarkers)updateEventPanel("Skipping. Clip already has markers.");else{var f=folderToChatFiles[n];f===void 0&&(f=folderToChatFiles[n]=new Folder(n).getFiles("*.chat"));var l=f.length;if(!l)updateEventPanel("Skipping. No *.chat file(s) found in media path.");else{updateEventPanel("Adding markers.");for(var p=0;p<l;p++){var c=f[p];c instanceof File&&c.exists&&createClipMarkersFromChatFile(i,c)}}}else updateWithError("Unable to determine media path of clip.")}function importFiles(){if(app.project){var r=File.openDialog("Choose files to import","0",!0);if(r){var t=getPPPInsertionBin();if(t){t.select();var e=[];if(e){for(var n=0;n<r.length;n++)e[n]=r[n].fsName;app.project.importFiles(e,!0,t,!1)}}else updateEventPanel("Could not find or create target bin.")}}}function getPPPInsertionBin(){var r="Here's where PProPanel puts things.",t=searchForBinWithName(r);if(t===0&&(app.project.rootItem.createBin(r),t=searchForBinWithName(r)),t)return t.select(),t}function searchForBinWithName(r){var t=function(e){if(e&&e.name===r&&e.type===2)return e;for(var n=0;n<e.children.numItems;n++)if(e.children[n]&&e.children[n].type===2){var a=t(e.children[n]);if(a)return a}};return t(app.project.rootItem)}function createClipMarkersFromChatFile(r,t){var e=null,n,a;readTextFile(t,function(i){var s=i.split("	"),o=s[0].trim(),f=convertTimecodeToSeconds(o);s.length===3&&f?(e&&createMarker(r,n,a,e),n=f,a=s[1].trim().slice(0,-1),e=s[2].trim()):e+="\n"+i}),e&&createMarker(r,n,a,e)}function createMarker(r,t,e,n){var a=r.createMarker(t),i=n.toLowerCase().split(" ");a.name=e,a.comments=n;for(var s=colors.GREEN,o,f=0;f<i.length;f++)o=i[f],o==="cut"||o==="edit"?s=colors.RED:o==="fix"||o==="replace"?s=colors.ORANGE:o==="audio"||o==="sound"?s=colors.YELLOW:o=="reacted"&&(s=colors.PURPLE);a.setColorByIndex(s)}function exitErr(r){alert(r),exit(-1)}function updateEventPanel(r){app.setSDKEventMessage(r,"info")}function updateWithError(r){app.setSDKEventMessage(r,"error")}function addStringMethods(){typeof String.prototype.trim=="undefined"&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")})}function getFolderName(r){if(!r)return null;var t=r.getMediaPath(),e=t.lastIndexOf(sep);return e>-1?t.slice(0,e):t}function convertTimecodeToSeconds(r){var t=r.split(":");if(t.length!==3)return 0;var e=parseInt(t[0])*3600,n=parseInt(t[1])*60,a=parseInt(t[2]);if(isNaN(e)||isNaN(n)||isNaN(a))return 0;var i=e+n+a;return i}function readTextFile(r,t){var e=r instanceof File?r:new File(r);if(e.exists){e.open("r")||exitErr("Unable to open file "+decodeURI(e.name)),e.encoding||(e.encoding="UTF-8");var n=e.read();e.close();var a=n.split("\n");if(typeof t=="function")for(var i=0;i<a.length;i++)t(a[i],i);return n}else return!1}main();
